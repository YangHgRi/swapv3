# SwapV3 - Solana 上的简化版 Uniswap V3

本项目是在 Solana 区块链上对 Uniswap V3 协议的简化实现，旨在为有兴趣在 Solana 上构建 DeFi 应用的开发者提供技术演示和教学资源。

## 核心功能

- **集中流动性:** 允许流动性提供者（LP）将其资本分配到特定的价格区间，从而提高资本效率。
- **多级费率:** 支持流动性池设置不同的费率等级，使 LP 能根据其承担的风险获得相应的补偿。
- **链上程序:** 所有核心逻辑都作为 Solana 程序（用 Rust 编写）实现，确保了去中心化和安全性。

## 架构概览

本程序采用模块化架构，将不同的功能分离到独立的 Rust 模块中：

- **`processor.rs`:** 程序的核心，负责处理传入的指令并将其分派给相应的逻辑处理器。它包含了 `InitializePool`、`AddLiquidity` 和 `Swap` 的实现。

- **`state.rs`:** 定义了代表程序链上状态的数据结构，包括 `Pool`、`Position` 和 `Tick`。所有状态对象都使用 `borsh` 进行序列化和反序列化。

- **`instruction.rs`:** 定义了程序接受的指令格式。这构成了与程序交互的客户端的公共 API。

- **`error.rs`:** 为程序定义了自定义错误类型，在操作失败时提供清晰、可调试的反馈。

- **`utils.rs`:** 包含了处理定点数运算的数学工具，这对于链上金融计算至关重要。它包括了根据 tick 计算平方根价格的函数，这是 Uniswap V3 模型的关键组成部分。

- **`lib.rs`:** Solana 程序的入口点。它从 Solana 运行时接收指令，并将其传递给 `processor` 进行处理。

## 工作原理

1. **池初始化:** 通过 `InitializePool` 指令创建一个新的流动性池，该指令会建立一个新的 `Pool` 账户，并设置其初始价格和费率。

2. **添加流动性:** LP 可以使用 `AddLiquidity` 指令在特定的价格范围（从 `tick_lower` 到 `tick_upper`）内向池中添加流动性。这将为 LP 创建或更新一个 `Position` 账户，并更新相应的 `Tick` 账户以反映新的流动性。

3. **代币交换:** 用户可以使用 `Swap` 指令将一种代币交换为另一种。程序会根据池中的活跃流动性和当前价格计算交换数量，并相应地更新池的状态。

本项目为理解和构建 Solana 上的复杂 DeFi 协议提供了一个坚实的基础。
